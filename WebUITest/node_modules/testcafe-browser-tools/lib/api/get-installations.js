"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const os_family_1 = __importDefault(require("os-family"));
const which_promise_1 = __importDefault(require("which-promise"));
const lodash_1 = require("lodash");
const fs_exists_promised_1 = __importDefault(require("../utils/fs-exists-promised"));
const exec_1 = require("../utils/exec");
const unquote_1 = __importDefault(require("../utils/unquote"));
const aliases_1 = __importDefault(require("../aliases"));
const MICROSOFT_EDGE_CLASS = 'Microsoft.MicrosoftEdge';
const MICROSOFT_EDGE_KEY_GLOB = `HKCU\\Software\\Classes\\ActivatableClasses\\Package\\${MICROSOFT_EDGE_CLASS}*`;
const BROWSER_COMMANDS_KEY_GLOB = root => `${root}\\Software\\Clients\\StartMenuInternet\\*\\shell\\open\\command`;
const LINE_WRAP = '\r\n';
const DOUBLE_LINE_WRAP = LINE_WRAP + LINE_WRAP;
const REGISTRY_BROWSER_PATH_PROPERTY = '(default)';
const REGISTRY_BROWSER_NAME_PROPERTY = 'PSPath';
const REGISTRY_PROPERTIES_RE = /^(\(default\)|PSPath)\s*:\s*(.*)$/;
const MAX_OUTPUT_WIDTH = 2 ** 31 - 1;
const POWERSHELL_PIPE_SYMBOL = '|';
const GET_REGISTRY_KEY_COMMAND = key => `Get-Item 'Registry::${key}'`;
const GET_BROWSER_PATH_PROPERTY_COMMAND = `Get-ItemProperty -Name '${REGISTRY_BROWSER_PATH_PROPERTY}'`;
const FORMAT_BROWSER_INFO_COMMAND = `Format-List -Property '${REGISTRY_BROWSER_PATH_PROPERTY}','${REGISTRY_BROWSER_NAME_PROPERTY}'`;
const LIMIT_OUTPUT_WIDTH_COMMAND = `Out-String -Width ${MAX_OUTPUT_WIDTH}`;
// NOTE: We have to use Write-Host for compatibility with PowerShell 2.0
const WRITE_HOST_COMMAND = 'Write-Host';
const GET_REGISTRY_BROWSER_PROPERTIES_COMMAND = key => [
    GET_REGISTRY_KEY_COMMAND(key),
    GET_BROWSER_PATH_PROPERTY_COMMAND,
    FORMAT_BROWSER_INFO_COMMAND,
    LIMIT_OUTPUT_WIDTH_COMMAND,
    WRITE_HOST_COMMAND
].join(POWERSHELL_PIPE_SYMBOL);
// Installation info cache
var installationsCache = null;
async function getRegistryKey(regKeyGlob) {
    return exec_1.execPowershell(GET_REGISTRY_KEY_COMMAND(regKeyGlob));
}
async function getRegistryBrowserProperties(regKeyGlob) {
    return exec_1.execPowershell(GET_REGISTRY_BROWSER_PROPERTIES_COMMAND(regKeyGlob));
}
// Find installations for different platforms
async function addInstallation(installations, name, instPath) {
    var fileExists = await fs_exists_promised_1.default(instPath);
    if (fileExists) {
        Object.keys(aliases_1.default).some(alias => {
            var { nameRe, cmd, macOpenCmdTemplate, path } = aliases_1.default[alias];
            if (nameRe.test(name)) {
                installations[alias] = { path: path || instPath, cmd, macOpenCmdTemplate };
                return true;
            }
            return false;
        });
    }
}
async function detectMicrosoftEdge() {
    const registryResult = await getRegistryKey(MICROSOFT_EDGE_KEY_GLOB);
    if (registryResult.stdout.includes(MICROSOFT_EDGE_CLASS))
        return aliases_1.default['edge'];
    return null;
}
async function searchInRegistry(registryRoot) {
    const installations = {};
    const registryResult = await getRegistryBrowserProperties(BROWSER_COMMANDS_KEY_GLOB(registryRoot));
    const data = registryResult.stdout
        .split(DOUBLE_LINE_WRAP)
        .map(block => block
        .split(LINE_WRAP)
        .map(line => line.match(REGISTRY_PROPERTIES_RE))
        .filter(match => !!match)
        .map(match => ({
        [match[1]]: unquote_1.default(match[2])
    })))
        .filter(block => block && block.length)
        .map(block => lodash_1.merge(...block));
    await Promise.all(data.map(record => addInstallation(installations, record[REGISTRY_BROWSER_NAME_PROPERTY], record[REGISTRY_BROWSER_PATH_PROPERTY])));
    return installations;
}
async function findWindowsBrowsers() {
    var machineRegisteredBrowsers = await searchInRegistry('HKEY_LOCAL_MACHINE');
    var userRegisteredBrowsers = await searchInRegistry('HKEY_CURRENT_USER');
    var installations = Object.assign(machineRegisteredBrowsers, userRegisteredBrowsers);
    var edgeAlias = await detectMicrosoftEdge();
    if (edgeAlias)
        installations['edge'] = edgeAlias;
    return installations;
}
async function findMacBrowsers() {
    var installations = {};
    // NOTE: replace the space symbol with code, because grep splits strings by space.
    var stdout = await exec_1.exec('ls "/Applications/" | grep -E "Chrome|Firefox|Opera|Safari|Chromium" | sed -E "s/ /032/"');
    await Promise.all(stdout
        .split('\n')
        .filter(fileName => !!fileName)
        .map(fileName => {
        // NOTE: restore space
        fileName = fileName.replace(/032/g, ' ');
        var name = fileName.replace(/.app$/, '');
        var path = `/Applications/${fileName}`;
        return addInstallation(installations, name, path);
    }));
    return installations;
}
async function findLinuxBrowsers() {
    var installations = {};
    var aliasCheckingPromises = Object
        .keys(aliases_1.default)
        .map(name => {
        var { linuxBinaries } = aliases_1.default[name];
        if (!linuxBinaries)
            return null;
        var detectionPromises = linuxBinaries
            .map(binary => {
            return which_promise_1.default(binary)
                .then(path => addInstallation(installations, name, path))
                .catch(() => {
                // NOTE: binary not found, just do nothing
                return;
            });
        });
        return Promise.all(detectionPromises);
    });
    await Promise.all(aliasCheckingPromises);
    return installations;
}
async function findBrowsers() {
    if (os_family_1.default.win)
        return await findWindowsBrowsers();
    if (os_family_1.default.mac)
        return await findMacBrowsers();
    if (os_family_1.default.linux)
        return await findLinuxBrowsers();
}
// API
/** @typedef {Object} BrowserInfo
 * @description Object that contains information about the browser installed on the machine.
 * @property {string|undefined} path - The path to the executable file that starts the browser.
 *  Required on MacOS machines. On Windows machines, it is used when the winOpenCmdTemplate property is undefined.
 * @property {string} cmd - Additional command line parameters.
 * @property {string} macOpenCmdTemplate - A [Mustache template](https://github.com/janl/mustache.js#templates)
 *  that provides parameters for launching the browser on a MacOS machine.
 * @property {string|undefined} winOpenCmdTemplate - A [Mustache template](https://github.com/janl/mustache.js#templates)
 *  that provides parameters for launching the browser on a Windows machine.  If undefined, the path to the
 *  executable file specified by the path property is used.
 * @example
 *  {
 *       path: 'C:\\ProgramFiles\\...\\firefox.exe',
 *       cmd: '-new-window',
 *       macOpenCmdTemplate: 'open -a "{{{path}}}" {{{pageUrl}}} --args {{{cmd}}}'
 *  }
 */
/**
 * Returns the list of the {@link BrowserInfo} objects that contain information about the browsers installed on the machine.
 * @function
 * @async
 * @name getInstallations
 * @returns {Object.<string, BrowserInfo>} List of the {@link BrowserInfo} objects
 *   containing information about the browsers installed on the machine.
 * @example
 * {
 *   chrome: {
 *       path: 'C:\\ProgramFiles\\...\\chrome.exe',
 *       cmd: '--new-window',
 *       macOpenCmdTemplate: 'open -n -a "{{{path}}}" --args {{{pageUrl}}} {{{cmd}}}'
 *   },
 *
 *   firefox: {
 *       path: 'C:\\ProgramFiles\\...\\firefox.exe',
 *       cmd: '-new-window',
 *       macOpenCmdTemplate: 'open -a "{{{path}}}" {{{pageUrl}}} --args {{{cmd}}}'
 *   }
 * }
 */
async function default_1() {
    if (!installationsCache)
        installationsCache = await findBrowsers();
    return installationsCache;
}
exports.default = default_1;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWluc3RhbGxhdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYXBpL2dldC1pbnN0YWxsYXRpb25zLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEsMERBQTJCO0FBQzNCLGtFQUFrQztBQUNsQyxtQ0FBK0I7QUFDL0IscUZBQWlEO0FBQ2pELHdDQUFxRDtBQUNyRCwrREFBdUM7QUFDdkMseURBQWlDO0FBRWpDLE1BQU0sb0JBQW9CLEdBQVEseUJBQXlCLENBQUM7QUFDNUQsTUFBTSx1QkFBdUIsR0FBSyx5REFBeUQsb0JBQW9CLEdBQUcsQ0FBQztBQUNuSCxNQUFNLHlCQUF5QixHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLGlFQUFpRSxDQUFDO0FBRW5ILE1BQU0sU0FBUyxHQUFVLE1BQU0sQ0FBQztBQUNoQyxNQUFNLGdCQUFnQixHQUFHLFNBQVMsR0FBRyxTQUFTLENBQUM7QUFFL0MsTUFBTSw4QkFBOEIsR0FBRyxXQUFXLENBQUM7QUFDbkQsTUFBTSw4QkFBOEIsR0FBRyxRQUFRLENBQUM7QUFDaEQsTUFBTSxzQkFBc0IsR0FBVyxtQ0FBbUMsQ0FBQztBQUUzRSxNQUFNLGdCQUFnQixHQUFHLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBRXJDLE1BQU0sc0JBQXNCLEdBQUcsR0FBRyxDQUFDO0FBRW5DLE1BQU0sd0JBQXdCLEdBQVksR0FBRyxDQUFDLEVBQUUsQ0FBQyx1QkFBdUIsR0FBRyxHQUFHLENBQUM7QUFDL0UsTUFBTSxpQ0FBaUMsR0FBRywyQkFBMkIsOEJBQThCLEdBQUcsQ0FBQztBQUN2RyxNQUFNLDJCQUEyQixHQUFTLDBCQUEwQiw4QkFBOEIsTUFBTSw4QkFBOEIsR0FBRyxDQUFDO0FBQzFJLE1BQU0sMEJBQTBCLEdBQVUscUJBQXFCLGdCQUFnQixFQUFFLENBQUM7QUFFbEYsd0VBQXdFO0FBQ3hFLE1BQU0sa0JBQWtCLEdBQUcsWUFBWSxDQUFDO0FB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bUJBQUUsQ0FBQyxHQUFHO1FBQ04sT0FBTyxNQUFNLGVBQWUsRUFBRSxDQUFDO0lBRW5DLElBQUksbUJBQUUsQ0FBQyxLQUFLO1FBQ1IsT0FBTyxNQUFNLGlCQUFpQixFQUFFLENBQUM7QUFDekMsQ0FBQztBQUdELE1BQU07QUFDTjs7Ozs7Ozs7Ozs7Ozs7OztHQWdCRztBQUVIOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FxQkc7QUFDWSxLQUFLO0lBQ2hCLElBQUksQ0FBQyxrQkFBa0I7UUFDbkIsa0JBQWtCLEdBQUcsTUFBTSxZQUFZLEVBQUUsQ0FBQztJQUU5QyxPQUFPLGtCQUFrQixDQUFDO0FBQzlCLENBQUM7QUFMRCw0QkFLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBPUyBmcm9tICdvcy1mYW1pbHknO1xuaW1wb3J0IHdoaWNoIGZyb20gJ3doaWNoLXByb21pc2UnO1xuaW1wb3J0IHsgbWVyZ2UgfSBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGV4aXN0cyBmcm9tICcuLi91dGlscy9mcy1leGlzdHMtcHJvbWlzZWQnO1xuaW1wb3J0IHsgZXhlYywgZXhlY1Bvd2Vyc2hlbGwgfSBmcm9tICcuLi91dGlscy9leGVjJztcbmltcG9ydCB1bnF1b3RlIGZyb20gJy4uL3V0aWxzL3VucXVvdGUnO1xuaW1wb3J0IEFMSUFTRVMgZnJvbSAnLi4vYWxpYXNlcyc7XG5cbmNvbnN0IE1JQ1JPU09GVF9FREdFX0NMQVNTICAgICAgPSAnTWljcm9zb2Z0Lk1pY3Jvc29mdEVkZ2UnO1xuY29uc3QgTUlDUk9TT0ZUX0VER0VfS0VZX0dMT0IgICA9IGBIS0NVXFxcXFNvZnR3YXJlXFxcXENsYXNzZXNcXFxcQWN0aXZhdGFibGVDbGFzc2VzXFxcXFBhY2thZ2VcXFxcJHtNSUNST1NPRlRfRURHRV9DTEFTU30qYDtcbmNvbnN0IEJST1dTRVJfQ09NTUFORFNfS0VZX0dMT0IgPSByb290ID0+IGAke3Jvb3R9XFxcXFNvZnR3YXJlXFxcXENsaWVudHNcXFxcU3RhcnRNZW51SW50ZXJuZXRcXFxcKlxcXFxzaGVsbFxcXFxvcGVuXFxcXGNvbW1hbmRgO1xuXG5jb25zdCBMSU5FX1dSQVAgICAgICAgID0gJ1xcclxcbic7XG5jb25zdCBET1VCTEVfTElORV9XUkFQID0gTElORV9XUkFQICsgTElORV9XUkFQO1xuXG5jb25zdCBSRUdJU1RSWV9CUk9XU0VSX1BBVEhfUFJPUEVSVFkgPSAnKGRlZmF1bHQpJztcbmNvbnN0IFJFR0lTVFJZX0JST1dTRVJfTkFNRV9QUk9QRVJUWSA9ICdQU1BhdGgnO1xuY29uc3QgUkVHSVNUUllfUFJPUEVSVElFU19SRSAgICAgICAgID0gL14oXFwoZGVmYXVsdFxcKXxQU1BhdGgpXFxzKjpcXHMqKC4qKSQvO1xuXG5jb25zdCBNQVhfT1VUUFVUX1dJRFRIID0gMiAqKiAzMSAtIDE7XG5cbmNvbnN0IFBPV0VSU0hFTExfUElQRV9TWU1CT0wgPSAnfCc7XG5cbmNvbnN0IEdFVF9SRUdJU1RSWV9LRVlfQ09NTUFORCAgICAgICAgICA9IGtleSA9PiBgR2V0LUl0ZW0gJ1JlZ2lzdHJ5Ojoke2tleX0nYDtcbmNvbnN0IEdFVF9CUk9XU0VSX1BBVEhfUFJPUEVSVFlfQ09NTUFORCA9IGBHZXQtSXRlbVByb3BlcnR5IC1OYW1lICcke1JFR0lTVFJZX0JST1dTRVJfUEFUSF9QUk9QRVJUWX0nYDtcbmNvbnN0IEZPUk1BVF9CUk9XU0VSX0lORk9fQ09NTUFORCAgICAgICA9IGBGb3JtYXQtTGlzdCAtUHJvcGVydHkgJyR7UkVHSVNUUllfQlJPV1NFUl9QQVRIX1BST1BFUlRZfScsJyR7UkVHSVNUUllfQlJPV1NFUl9OQU1FX1BST1BFUlRZfSdgO1xuY29uc3QgTElNSVRfT1VUUFVUX1dJRFRIX0NPTU1BTkQgICAgICAgID0gYE91dC1TdHJpbmcgLVdpZHRoICR7TUFYX09VVFBVVF9XSURUSH1gO1xuXG4vLyBOT1RFOiBXZSBoYXZlIHRvIHVzZSBXcml0ZS1Ib3N0IGZvciBjb21wYXRpYmlsaXR5IHdpdGggUG93ZXJTaGVsbCAyLjBcbmNvbnN0IFdSSVRFX0hPU1RfQ09NTUFORCA9ICdXcml0ZS1Ib3N0JztcblxuY29uc3QgR0VUX1JFR0lTVFJZX0JST1dTRVJfUFJPUEVSVElFU19DT01NQU5EID0ga2V5ID0+IFtcbiAgICBHRVRfUkVHSVNUUllfS0VZX0NPTU1BTkQoa2V5KSxcbiAgICBHRVRfQlJPV1NFUl9QQVRIX1BST1BFUlRZX0NPTU1BTkQsXG4gICAgRk9STUFUX0JST1dTRVJfSU5GT19DT01NQU5ELFxuICAgIExJTUlUX09VVFBVVF9XSURUSF9DT01NQU5ELFxuICAgIFdSSVRFX0hPU1RfQ09NTUFORFxuXS5qb2luKFBPV0VSU0hFTExfUElQRV9TWU1CT0wpO1xuXG4vLyBJbnN0YWxsYXRpb24gaW5mbyBjYWNoZVxudmFyIGluc3RhbGxhdGlvbnNDYWNoZSA9IG51bGw7XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFJlZ2lzdHJ5S2V5IChyZWdLZXlHbG9iKSB7XG4gICAgcmV0dXJuIGV4ZWNQb3dlcnNoZWxsKEdFVF9SRUdJU1RSWV9LRVlfQ09NTUFORChyZWdLZXlHbG9iKSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFJlZ2lzdHJ5QnJvd3NlclByb3BlcnRpZXMgKHJlZ0tleUdsb2IpIHtcbiAgICByZXR1cm4gZXhlY1Bvd2Vyc2hlbGwoR0VUX1JFR0lTVFJZX0JST1dTRVJfUFJPUEVSVElFU19DT01NQU5EKHJlZ0tleUdsb2IpKTtcbn1cblxuLy8gRmluZCBpbnN0YWxsYXRpb25zIGZvciBkaWZmZXJlbnQgcGxhdGZvcm1zXG5hc3luYyBmdW5jdGlvbiBhZGRJbnN0YWxsYXRpb24gKGluc3RhbGxhdGlvbnMsIG5hbWUsIGluc3RQYXRoKSB7XG4gICAgdmFyIGZpbGVFeGlzdHMgPSBhd2FpdCBleGlzdHMoaW5zdFBhdGgpO1xuXG4gICAgaWYgKGZpbGVFeGlzdHMpIHtcbiAgICAgICAgT2JqZWN0LmtleXMoQUxJQVNFUykuc29tZShhbGlhcyA9PiB7XG4gICAgICAgICAgICB2YXIgeyBuYW1lUmUsIGNtZCwgbWFjT3BlbkNtZFRlbXBsYXRlLCBwYXRoIH0gPSBBTElBU0VTW2FsaWFzXTtcblxuICAgICAgICAgICAgaWYgKG5hbWVSZS50ZXN0KG5hbWUpKSB7XG4gICAgICAgICAgICAgICAgaW5zdGFsbGF0aW9uc1thbGlhc10gPSB7IHBhdGg6IHBhdGggfHwgaW5zdFBhdGgsIGNtZCwgbWFjT3BlbkNtZFRlbXBsYXRlIH07XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBkZXRlY3RNaWNyb3NvZnRFZGdlICgpIHtcbiAgICBjb25zdCByZWdpc3RyeVJlc3VsdCA9IGF3YWl0IGdldFJlZ2lzdHJ5S2V5KE1JQ1JPU09GVF9FREdFX0tFWV9HTE9CKTtcblxuICAgIGlmIChyZWdpc3RyeVJlc3VsdC5zdGRvdXQuaW5jbHVkZXMoTUlDUk9TT0ZUX0VER0VfQ0xBU1MpKVxuICAgICAgICByZXR1cm4gQUxJQVNFU1snZWRnZSddO1xuXG4gICAgcmV0dXJuIG51bGw7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNlYXJjaEluUmVnaXN0cnkgKHJlZ2lzdHJ5Um9vdCkge1xuICAgIGNvbnN0IGluc3RhbGxhdGlvbnMgID0ge307XG4gICAgY29uc3QgcmVnaXN0cnlSZXN1bHQgPSAgYXdhaXQgZ2V0UmVnaXN0cnlCcm93c2VyUHJvcGVydGllcyhCUk9XU0VSX0NPTU1BTkRTX0tFWV9HTE9CKHJlZ2lzdHJ5Um9vdCkpO1xuXG4gICAgY29uc3QgZGF0YSA9IHJlZ2lzdHJ5UmVzdWx0LnN0ZG91dFxuICAgICAgICAuc3BsaXQoRE9VQkxFX0xJTkVfV1JBUClcbiAgICAgICAgLm1hcChibG9jayA9PiBibG9ja1xuICAgICAgICAgICAgLnNwbGl0KExJTkVfV1JBUClcbiAgICAgICAgICAgIC5tYXAobGluZSA9PiBsaW5lLm1hdGNoKFJFR0lTVFJZX1BST1BFUlRJRVNfUkUpKVxuICAgICAgICAgICAgLmZpbHRlcihtYXRjaCA9PiAhIW1hdGNoKVxuICAgICAgICAgICAgLm1hcChtYXRjaCA9PiAoe1xuICAgICAgICAgICAgICAgIFttYXRjaFsxXV06IHVucXVvdGUobWF0Y2hbMl0pXG4gICAgICAgICAgICB9KSlcbiAgICAgICAgKVxuICAgICAgICAuZmlsdGVyKGJsb2NrID0+IGJsb2NrICYmIGJsb2NrLmxlbmd0aClcbiAgICAgICAgLm1hcChibG9jayA9PiBtZXJnZSguLi5ibG9jaykpO1xuXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoZGF0YS5tYXAocmVjb3JkID0+IGFkZEluc3RhbGxhdGlvbihpbnN0YWxsYXRpb25zLCByZWNvcmRbUkVHSVNUUllfQlJPV1NFUl9OQU1FX1BST1BFUlRZXSwgcmVjb3JkW1JFR0lTVFJZX0JST1dTRVJfUEFUSF9QUk9QRVJUWV0pKSk7XG5cbiAgICByZXR1cm4gaW5zdGFsbGF0aW9ucztcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmluZFdpbmRvd3NCcm93c2VycyAoKSB7XG4gICAgdmFyIG1hY2hpbmVSZWdpc3RlcmVkQnJvd3NlcnMgPSBhd2FpdCBzZWFyY2hJblJlZ2lzdHJ5KCdIS0VZX0xPQ0FMX01BQ0hJTkUnKTtcbiAgICB2YXIgdXNlclJlZ2lzdGVyZWRCcm93c2VycyAgICA9IGF3YWl0IHNlYXJjaEluUmVnaXN0cnkoJ0hLRVlfQ1VSUkVOVF9VU0VSJyk7XG4gICAgdmFyIGluc3RhbGxhdGlvbnMgICAgICAgICAgICAgPSBPYmplY3QuYXNzaWduKG1hY2hpbmVSZWdpc3RlcmVkQnJvd3NlcnMsIHVzZXJSZWdpc3RlcmVkQnJvd3NlcnMpO1xuICAgIHZhciBlZGdlQWxpYXMgICAgICAgICAgICAgICAgID0gYXdhaXQgZGV0ZWN0TWljcm9zb2Z0RWRnZSgpO1xuXG4gICAgaWYgKGVkZ2VBbGlhcylcbiAgICAgICAgaW5zdGFsbGF0aW9uc1snZWRnZSddID0gZWRnZUFsaWFzO1xuXG4gICAgcmV0dXJuIGluc3RhbGxhdGlvbnM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpbmRNYWNCcm93c2VycyAoKSB7XG4gICAgdmFyIGluc3RhbGxhdGlvbnMgPSB7fTtcblxuICAgIC8vIE5PVEU6IHJlcGxhY2UgdGhlIHNwYWNlIHN5bWJvbCB3aXRoIGNvZGUsIGJlY2F1c2UgZ3JlcCBzcGxpdHMgc3RyaW5ncyBieSBzcGFjZS5cbiAgICB2YXIgc3Rkb3V0ID0gYXdhaXQgZXhlYygnbHMgXCIvQXBwbGljYXRpb25zL1wiIHwgZ3JlcCAtRSBcIkNocm9tZXxGaXJlZm94fE9wZXJhfFNhZmFyaXxDaHJvbWl1bVwiIHwgc2VkIC1FIFwicy8gLzAzMi9cIicpO1xuXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoc3Rkb3V0XG4gICAgICAgIC5zcGxpdCgnXFxuJylcbiAgICAgICAgLmZpbHRlcihmaWxlTmFtZSA9PiAhIWZpbGVOYW1lKVxuICAgICAgICAubWFwKGZpbGVOYW1lID0+IHtcbiAgICAgICAgICAgIC8vIE5PVEU6IHJlc3RvcmUgc3BhY2VcbiAgICAgICAgICAgIGZpbGVOYW1lID0gZmlsZU5hbWUucmVwbGFjZSgvMDMyL2csICcgJyk7XG5cbiAgICAgICAgICAgIHZhciBuYW1lID0gZmlsZU5hbWUucmVwbGFjZSgvLmFwcCQvLCAnJyk7XG4gICAgICAgICAgICB2YXIgcGF0aCA9IGAvQXBwbGljYXRpb25zLyR7ZmlsZU5hbWV9YDtcblxuICAgICAgICAgICAgcmV0dXJuIGFkZEluc3RhbGxhdGlvbihpbnN0YWxsYXRpb25zLCBuYW1lLCBwYXRoKTtcbiAgICAgICAgfSkpO1xuXG4gICAgcmV0dXJuIGluc3RhbGxhdGlvbnM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpbmRMaW51eEJyb3dzZXJzICgpIHtcbiAgICB2YXIgaW5zdGFsbGF0aW9ucyA9IHt9O1xuXG4gICAgdmFyIGFsaWFzQ2hlY2tpbmdQcm9taXNlcyA9IE9iamVjdFxuICAgICAgICAua2V5cyhBTElBU0VTKVxuICAgICAgICAubWFwKG5hbWUgPT4ge1xuICAgICAgICAgICAgdmFyIHsgbGludXhCaW5hcmllcyB9ID0gQUxJQVNFU1tuYW1lXTtcblxuICAgICAgICAgICAgaWYgKCFsaW51eEJpbmFyaWVzKVxuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuXG4gICAgICAgICAgICB2YXIgZGV0ZWN0aW9uUHJvbWlzZXMgPSBsaW51eEJpbmFyaWVzXG4gICAgICAgICAgICAgICAgLm1hcChiaW5hcnkgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2hpY2goYmluYXJ5KVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4ocGF0aCA9PiBhZGRJbnN0YWxsYXRpb24oaW5zdGFsbGF0aW9ucywgbmFtZSwgcGF0aCkpXG4gICAgICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE5PVEU6IGJpbmFyeSBub3QgZm91bmQsIGp1c3QgZG8gbm90aGluZ1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5hbGwoZGV0ZWN0aW9uUHJvbWlzZXMpO1xuICAgICAgICB9KTtcblxuICAgIGF3YWl0IFByb21pc2UuYWxsKGFsaWFzQ2hlY2tpbmdQcm9taXNlcyk7XG5cbiAgICByZXR1cm4gaW5zdGFsbGF0aW9ucztcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmluZEJyb3dzZXJzICgpIHtcbiAgICBpZiAoT1Mud2luKVxuICAgICAgICByZXR1cm4gYXdhaXQgZmluZFdpbmRvd3NCcm93c2VycygpO1xuXG4gICAgaWYgKE9TLm1hYylcbiAgICAgICAgcmV0dXJuIGF3YWl0IGZpbmRNYWNCcm93c2VycygpO1xuXG4gICAgaWYgKE9TLmxpbnV4KVxuICAgICAgICByZXR1cm4gYXdhaXQgZmluZExpbnV4QnJvd3NlcnMoKTtcbn1cblxuXG4vLyBBUElcbi8qKiBAdHlwZWRlZiB7T2JqZWN0fSBCcm93c2VySW5mb1xuICogQGRlc2NyaXB0aW9uIE9iamVjdCB0aGF0IGNvbnRhaW5zIGluZm9ybWF0aW9uIGFib3V0IHRoZSBicm93c2VyIGluc3RhbGxlZCBvbiB0aGUgbWFjaGluZS5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfHVuZGVmaW5lZH0gcGF0aCAtIFRoZSBwYXRoIHRvIHRoZSBleGVjdXRhYmxlIGZpbGUgdGhhdCBzdGFydHMgdGhlIGJyb3dzZXIuXG4gKiAgUmVxdWlyZWQgb24gTWFjT1MgbWFjaGluZXMuIE9uIFdpbmRvd3MgbWFjaGluZXMsIGl0IGlzIHVzZWQgd2hlbiB0aGUgd2luT3BlbkNtZFRlbXBsYXRlIHByb3BlcnR5IGlzIHVuZGVmaW5lZC5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjbWQgLSBBZGRpdGlvbmFsIGNvbW1hbmQgbGluZSBwYXJhbWV0ZXJzLlxuICogQHByb3BlcnR5IHtzdHJpbmd9IG1hY09wZW5DbWRUZW1wbGF0ZSAtIEEgW011c3RhY2hlIHRlbXBsYXRlXShodHRwczovL2dpdGh1Yi5jb20vamFubC9tdXN0YWNoZS5qcyN0ZW1wbGF0ZXMpXG4gKiAgdGhhdCBwcm92aWRlcyBwYXJhbWV0ZXJzIGZvciBsYXVuY2hpbmcgdGhlIGJyb3dzZXIgb24gYSBNYWNPUyBtYWNoaW5lLlxuICogQHByb3BlcnR5IHtzdHJpbmd8dW5kZWZpbmVkfSB3aW5PcGVuQ21kVGVtcGxhdGUgLSBBIFtNdXN0YWNoZSB0ZW1wbGF0ZV0oaHR0cHM6Ly9naXRodWIuY29tL2phbmwvbXVzdGFjaGUuanMjdGVtcGxhdGVzKVxuICogIHRoYXQgcHJvdmlkZXMgcGFyYW1ldGVycyBmb3IgbGF1bmNoaW5nIHRoZSBicm93c2VyIG9uIGEgV2luZG93cyBtYWNoaW5lLiAgSWYgdW5kZWZpbmVkLCB0aGUgcGF0aCB0byB0aGVcbiAqICBleGVjdXRhYmxlIGZpbGUgc3BlY2lmaWVkIGJ5IHRoZSBwYXRoIHByb3BlcnR5IGlzIHVzZWQuXG4gKiBAZXhhbXBsZVxuICogIHtcbiAqICAgICAgIHBhdGg6ICdDOlxcXFxQcm9ncmFtRmlsZXNcXFxcLi4uXFxcXGZpcmVmb3guZXhlJyxcbiAqICAgICAgIGNtZDogJy1uZXctd2luZG93JyxcbiAqICAgICAgIG1hY09wZW5DbWRUZW1wbGF0ZTogJ29wZW4gLWEgXCJ7e3twYXRofX19XCIge3t7cGFnZVVybH19fSAtLWFyZ3Mge3t7Y21kfX19J1xuICogIH1cbiAqL1xuXG4vKipcbiAqIFJldHVybnMgdGhlIGxpc3Qgb2YgdGhlIHtAbGluayBCcm93c2VySW5mb30gb2JqZWN0cyB0aGF0IGNvbnRhaW4gaW5mb3JtYXRpb24gYWJvdXQgdGhlIGJyb3dzZXJzIGluc3RhbGxlZCBvbiB0aGUgbWFjaGluZS5cbiAqIEBmdW5jdGlvblxuICogQGFzeW5jXG4gKiBAbmFtZSBnZXRJbnN0YWxsYXRpb25zXG4gKiBAcmV0dXJucyB7T2JqZWN0LjxzdHJpbmcsIEJyb3dzZXJJbmZvPn0gTGlzdCBvZiB0aGUge0BsaW5rIEJyb3dzZXJJbmZvfSBvYmplY3RzXG4gKiAgIGNvbnRhaW5pbmcgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGJyb3dzZXJzIGluc3RhbGxlZCBvbiB0aGUgbWFjaGluZS5cbiAqIEBleGFtcGxlXG4gKiB7XG4gKiAgIGNocm9tZToge1xuICogICAgICAgcGF0aDogJ0M6XFxcXFByb2dyYW1GaWxlc1xcXFwuLi5cXFxcY2hyb21lLmV4ZScsXG4gKiAgICAgICBjbWQ6ICctLW5ldy13aW5kb3cnLFxuICogICAgICAgbWFjT3BlbkNtZFRlbXBsYXRlOiAnb3BlbiAtbiAtYSBcInt7e3BhdGh9fX1cIiAtLWFyZ3Mge3t7cGFnZVVybH19fSB7e3tjbWR9fX0nXG4gKiAgIH0sXG4gKlxuICogICBmaXJlZm94OiB7XG4gKiAgICAgICBwYXRoOiAnQzpcXFxcUHJvZ3JhbUZpbGVzXFxcXC4uLlxcXFxmaXJlZm94LmV4ZScsXG4gKiAgICAgICBjbWQ6ICctbmV3LXdpbmRvdycsXG4gKiAgICAgICBtYWNPcGVuQ21kVGVtcGxhdGU6ICdvcGVuIC1hIFwie3t7cGF0aH19fVwiIHt7e3BhZ2VVcmx9fX0gLS1hcmdzIHt7e2NtZH19fSdcbiAqICAgfVxuICogfVxuICovXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKCFpbnN0YWxsYXRpb25zQ2FjaGUpXG4gICAgICAgIGluc3RhbGxhdGlvbnNDYWNoZSA9IGF3YWl0IGZpbmRCcm93c2VycygpO1xuXG4gICAgcmV0dXJuIGluc3RhbGxhdGlvbnNDYWNoZTtcbn1cbiJdfQ==